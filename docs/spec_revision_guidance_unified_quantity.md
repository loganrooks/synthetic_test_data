# Guidance for Revising `synthetic_data_package_specification.md`
## Applying the "Unified Quantity Specification" Pattern

**Date:** 2025-05-11

**Author:** Architect Mode

**Purpose:** This document provides detailed instructions for the `spec-pseudocode` mode on how to revise the existing [`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md) to incorporate the "Unified Quantity Specification" architectural pattern. This pattern is crucial for enabling both deterministic and flexible (probabilistic/ranged) control over the quantity of sub-elements generated by the `synthetic_test_data` package.

**Key Architectural Documents to Reference:**
*   [`docs/architecture_overview.md`](docs/architecture_overview.md) (for the pattern definition)
*   Memory Bank: [`memory-bank/globalContext.md`](memory-bank/globalContext.md) (System Patterns & Decision Log)
*   Memory Bank: [`memory-bank/mode-specific/architect.md`](memory-bank/mode-specific/architect.md) (Data Model: UnifiedQuantitySpecification)

## 1. Nature of Changes: Reformation, Not Overhaul
### Justification for Reformation over Fresh Start:

Reforming the existing specification ([`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md)) is the recommended approach for the following reasons:

1.  **Preservation of Existing Work:** The current specification document, despite the issue with quantity definition, contains a substantial amount of detailed and valuable information. This includes the overall package API, definitions for various EPUB generation flexibility points (ToC styles, page numbering, citation methods, multimedia handling, etc.), PDF and Markdown specific settings, plugin architecture considerations, and more. A fresh start would discard this effort and require `spec-pseudocode` to regenerate this complex information, risking loss of nuance and detail already captured.
2.  **Targeted Nature of the Change:** The "Unified Quantity Specification" is a specific architectural pattern that primarily affects how *quantities* of sub-elements are defined in the configuration. While this change is significant for those specific parameters, the majority of the specification's structure, content, and other detailed settings remain valid and provide a strong foundation.
3.  **Efficiency:** Reforming the document by surgically updating the relevant quantity parameters and their schema definitions is a more efficient use of time and resources compared to rewriting the entire document. It allows `spec-pseudocode` to focus on implementing this specific change rather than re-establishing the entire context.
4.  **Consistency:** Modifying the existing document helps maintain consistency with the thought process and decisions that have already gone into its creation. A fresh start could inadvertently lead to different interpretations or omissions of previously agreed-upon details.

Therefore, the task is to carefully integrate the "Unified Quantity Specification" into the existing framework of [`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md), enhancing its precision and testability without losing the comprehensive detail already present.

The introduction of the "Unified Quantity Specification" is a **reformation** of how quantities are defined within the existing configuration schema. It does **not** require a complete overhaul or deletion of the current [`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md).

The core task is to:
*   Identify existing configuration parameters that control the number/occurrence of elements.
*   Replace or consolidate these parameters with new, single configuration keys that adhere to the "Unified Quantity Specification" structure.
*   Update schema definitions and examples accordingly.

## 2. The "Unified Quantity Specification" Structure

As defined in [`docs/architecture_overview.md`](docs/architecture_overview.md) and the Memory Bank, any configuration key using this pattern can accept one of the following:

*   **Exact Count (Integer):** `element_count_config: 5`
*   **Range (Object with `min`, `max`):** `element_count_config: { "min": 3, "max": 7 }`
*   **Probabilistic (Object with `chance`, optional `per_unit_of`, optional `max_total`):**
    `element_count_config: { "chance": 0.1, "per_unit_of": "paragraph", "max_total": 20 }`

## 3. Specific Changes Required in `synthetic_data_package_specification.md`

The following sections and parameters in [`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md) need to be modified. This list is not exhaustive; a thorough review of the document is required to identify all relevant parameters.

### 3.1. Section: `epub_specific_settings` (and similar for PDF/Markdown)

#### 3.1.1. Content & Structure (Chapters, Sections)

*   **Current Parameters (Example for Chapters):**
    *   `min_chapters: 1`
    *   `max_chapters: 10`
*   **Revised Parameter:**
    *   `chapters_config: <UnifiedQuantitySpecification>`
*   **Example Usage in Spec:**
    *   `chapters_config: 5` (Deterministic)
    *   `chapters_config: { "min": 3, "max": 7 }` (Ranged)
    *   `chapters_config: { "chance": 0.8, "per_unit_of": "document", "max_total": 1 }` (If a document might or might not have chapters based on a high-level chance, though less common for chapters themselves, more for sub-elements. For chapters, min/max or exact is more typical). *Adjust `per_unit_of` and `chance` logic as sensible for the element.*

*   **Action:**
    1.  Replace `min_chapters` and `max_chapters` with `chapters_config`.
    2.  Update the schema description for `chapters_config` to detail it accepts the Unified Quantity Specification.
    3.  Apply the same logic to `min_sections_per_chapter` and `max_sections_per_chapter`, consolidating them into `sections_per_chapter_config: <UnifiedQuantitySpecification>`.

#### 3.1.2. Notes System (Footnotes/Endnotes)

*   **Current Parameter:**
    *   `note_occurrence_chance: 0.15`
*   **Revised Parameter:**
    *   `notes_config: <UnifiedQuantitySpecification>`
*   **Example Usage in Spec:**
    *   `notes_config: 10` (Exactly 10 notes in the scope defined by the generator, e.g., per document or per chapter if applicable)
    *   `notes_config: { "min": 5, "max": 15 }` (Between 5 and 15 notes)
    *   `notes_config: { "chance": 0.15, "per_unit_of": "paragraph", "max_total": 50 }` (Probabilistic per paragraph)
*   **Action:**
    1.  Replace `note_occurrence_chance` with `notes_config`.
    2.  The `per_unit_of` field in the probabilistic option becomes critical here (e.g., "paragraph", "page_equivalent", "chapter"). The spec should clarify how the generator will interpret this.
    3.  Consider if `secondary_note_occurrence_chance` also needs this treatment, becoming `secondary_notes_config`.

#### 3.1.3. Multimedia (Images)

*   **Current Parameters:**
    *   `min_images_per_file: 0`
    *   `max_images_per_file: 3`
*   **Revised Parameter:**
    *   `images_config: <UnifiedQuantitySpecification>`
*   **Example Usage in Spec:**
    *   `images_config: 2` (Exactly 2 images per file/scope)
    *   `images_config: { "min": 0, "max": 3 }` (Ranged)
    *   `images_config: { "chance": 0.1, "per_unit_of": "chapter_section", "max_total": 5 }` (Probabilistic)
*   **Action:**
    1.  Replace `min_images_per_file` and `max_images_per_file` with `images_config`.
    2.  Update schema and examples.

#### 3.1.4. Content Elements (Tables)

*   **Current Parameters:**
    *   `include_tables_chance: 0.05`
    *   `min_rows: 2`, `max_rows: 5`
    *   `min_cols: 2`, `max_cols: 4`
*   **Revised Parameters:**
    *   `tables_occurrence_config: <UnifiedQuantitySpecification>` (for whether tables appear at all)
    *   `table_rows_config: <UnifiedQuantitySpecification>`
    *   `table_cols_config: <UnifiedQuantitySpecification>`
*   **Example Usage in Spec:**
    *   `tables_occurrence_config: { "chance": 0.05, "per_unit_of": "document" }`
    *   `table_rows_config: { "min": 2, "max": 5 }`
    *   `table_cols_config: 3` (Deterministic columns)
*   **Action:**
    1.  Replace `include_tables_chance` with `tables_occurrence_config`.
    2.  Replace `min_rows`/`max_rows` with `table_rows_config`.
    3.  Replace `min_cols`/`max_cols` with `table_cols_config`.
    4.  Update schema and examples.

#### 3.1.5. Other Potential Areas:
*   **List items:** If there are parameters like `min_list_items`, `max_list_items`. Consolidate to `list_items_config`.
*   **Code blocks:** `include_code_blocks_chance` could become `code_blocks_occurrence_config`.
*   **Poetry lines/stanzas:** `include_poetry_chance` could become `poetry_occurrence_config`.
*   Any other parameter that implies a count or a chance of multiple occurrences.

### 3.2. General Schema Updates

*   For each modified parameter, ensure the YAML schema definition clearly states that it accepts the "Unified Quantity Specification" and provide brief examples of each type (integer, range object, probabilistic object).
*   It might be beneficial to define the "Unified Quantity Specification" once as a reusable schema component (e.g., using YAML anchors if the schema language supports it, or by referencing its definition in the documentation) to avoid repetition.

### 3.3. Update Examples

Review and update all YAML configuration examples throughout the document (e.g., in section 2.1 Example Usage, section 3.1.1, etc.) to reflect the new consolidated configuration keys and demonstrate the different ways to specify quantities (exact, range, probabilistic).

## 4. Clarification for Generator Logic (Informational for Spec)

While the `spec-pseudocode` mode focuses on the specification document, it's useful to briefly mention that the generator logic (e.g., in `EpubGenerator`) will need to be adapted to:
1.  Parse the `UnifiedQuantitySpecification` for relevant keys.
2.  If an integer is provided, use that exact count.
3.  If a `min`/`max` object is provided, generate a random integer within that range (inclusive).
4.  If a `chance` object is provided:
    *   Determine the number of "units" (e.g., paragraphs in a chapter).
    *   For each unit, check against the `chance`.
    *   Respect the `max_total` if provided.

This ensures the specification implicitly guides the `code` mode later.

## 5. Conclusion

By systematically applying this reformation, the [`specifications/synthetic_data_package_specification.md`](specifications/synthetic_data_package_specification.md) will accurately reflect the new architectural pattern, enabling the development of a more robust and testable `synthetic_test_data` package. The goal is clarity and precision in how element quantities are configured.